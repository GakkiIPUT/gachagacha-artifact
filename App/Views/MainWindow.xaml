<Window x:Class="Gacha.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:Gacha.ViewModels"
        mc:Ignorable="d"
        Title="Genshin Artifact Scorer" Width="1280" Height="800"
        WindowStartupLocation="CenterScreen">
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <DockPanel>
        <!-- ヘッダー -->
        <ToolBar DockPanel.Dock="Top">
            <!-- 表示切替：画像(既定) / 文字 -->
            <ToggleButton IsChecked="{Binding IsImageMode, Mode=TwoWay}"
                           Content="{Binding L_DisplayImage}" ToolTip="画像⇄文字 切替"/>
            <Separator/>

            <!-- ソートモード：スコア順（既定） / ゲーム内風 -->
            <TextBlock VerticalAlignment="Center" Margin="8,0,4,0" Text="{Binding L_SortLabel}"/>
            <ComboBox Width="150"
                      SelectedValuePath="Tag"
                      SelectedValue="{Binding SortMode, Mode=TwoWay}">
                       <ComboBoxItem Content="{Binding L_SortModeScore}" Tag="Score"/>
                       <ComboBoxItem Content="{Binding L_SortModeGame}" Tag="GameLike"/>
            </ComboBox>

            <!-- スコアプリセット（CV_ONLY 既定） -->
            <TextBlock VerticalAlignment="Center" Margin="16,0,4,0"  Text="{Binding L_PresetLabel}"/>
            <ComboBox Width="160"
                      SelectedValuePath="Content"
                      SelectedValue="{Binding SelectedPreset, Mode=TwoWay}">
                <ComboBoxItem Content="CV_ONLY" />
                <ComboBoxItem Content="CV_ATK" />
                <ComboBoxItem Content="CV_HP" />
                <ComboBoxItem Content="CV_DEF" />
                <ComboBoxItem Content="CV_EM" />
            </ComboBox>

            <!-- ゲーム内風ソートの対象列（サブのみ） -->
            <StackPanel Orientation="Horizontal" Margin="16,0,0,0"
                        Visibility="{Binding IsGameLikeSort, Converter={StaticResource BoolToVisibility}}">
                <TextBlock VerticalAlignment="Center" Text="{Binding L_TargetLabel}" Margin="0,0,4,0"/>
                <ComboBox Width="140"
                          SelectedValuePath="Tag"
                          SelectedValue="{Binding GameLikeKey, Mode=TwoWay}">
                    <ComboBoxItem Content="会心ダメ(サブ)" Tag="CD"/>
                    <ComboBoxItem Content="会心率(サブ)" Tag="CR"/>
                    <ComboBoxItem Content="攻撃%(サブ)" Tag="ATKp"/>
                    <ComboBoxItem Content="HP%(サブ)" Tag="HPp"/>
                    <ComboBoxItem Content="防御%(サブ)" Tag="DEFp"/>
                    <ComboBoxItem Content="熟知(サブ)" Tag="EM"/>
                </ComboBox>
                <ToggleButton Content="{Binding L_Descending}" IsChecked="{Binding GameLikeDesc, Mode=TwoWay}" Margin="8,0,0,0"/>
            </StackPanel>

            <Separator/>

            <!-- 言語 -->
            <TextBlock VerticalAlignment="Center" Margin="16,0,4,0" Text="{Binding L_LanguageLabel}"/>
            <ComboBox Width="110"
                      SelectedValuePath="Tag"
                      SelectedValue="{Binding Language, Mode=TwoWay}">
                <ComboBoxItem Content="日本語" Tag="ja"/>
                <ComboBoxItem Content="English" Tag="en"/>
                <ComboBoxItem Content="中文" Tag="zh"/>
            </ComboBox>

            <Separator/>

            <!-- 部位フィルタ -->
            <TextBlock VerticalAlignment="Center" Margin="16,0,4,0" Text="{Binding L_SlotLabel}"/>
            <ComboBox Width="130"
                      SelectedValuePath="Tag"
                      SelectedValue="{Binding SlotFilter, Mode=TwoWay}">
                <ComboBoxItem Content="{Binding L_SlotAll}"     Tag="All"/>
                <ComboBoxItem Content="{Binding L_SlotFlower}"  Tag="flower"/>
                <ComboBoxItem Content="{Binding L_SlotPlume}"   Tag="plume"/>
                <ComboBoxItem Content="{Binding L_SlotSands}"   Tag="sands"/>
                <ComboBoxItem Content="{Binding L_SlotGoblet}"  Tag="goblet"/>
                <ComboBoxItem Content="{Binding L_SlotCirclet}" Tag="circlet"/>
            </ComboBox>

            <!-- セット絞り込み（複数選択） -->
            <Button Content="{Binding SetFilterButtonLabel}"
                    Command="{Binding OpenSetFilterCommand}" Margin="8,0,0,0"/>


            <!-- 入出力 -->
             <Button Content="{Binding L_ImportGood}" Command="{Binding ImportGoodCommand}" />
             <Button Content="{Binding L_ExportCsv}"  Command="{Binding ExportCsvCommand}" Margin="8,0,0,0"/>
             <Button Content="{Binding L_Settings}"    Command="{Binding OpenSettingsCommand}" Margin="8,0,0,0"/>
            <TextBlock Margin="16,0,0,0" VerticalAlignment="Center"
                       Text="{Binding StatusText}"/>
        </ToolBar>

        <!-- メイン領域：画像カード vs 文字テーブル -->
        <Grid>
            <Grid.Resources>
                <!-- 画像カード用テンプレ -->
                <DataTemplate x:Key="ArtifactCardTemplate">
                    <Border CornerRadius="16" Padding="8" Margin="8" Background="#0E000000">
                        <Grid>
                            <!-- 画像（フォールバック対応） -->
                            <Image Width="220" Height="220" Stretch="UniformToFill">
                                <Image.Style>
                                    <Style TargetType="Image">
                                        <Setter Property="Source" Value="{Binding ImagePath}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasImage}" Value="False">
                                                <Setter Property="Source" Value="{Binding PlaceholderPath}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Image.Style>
                            </Image>
                         <!-- セット名＋部位名（上部帯） -->
                         <Border Background="#B3000000" CornerRadius="8"
                                 HorizontalAlignment="Left" VerticalAlignment="Top" Margin="6,6,80,0">
                           <StackPanel Orientation="Vertical" Margin="6,3">
                             <TextBlock Foreground="White" FontWeight="SemiBold"
                                        Text="{Binding SetName}"/>
                             <TextBlock Foreground="#FFD0D0D0" FontSize="12"
                                        Text="{Binding SlotName}"/>
                           </StackPanel>
                         </Border>
                                        
                            <!-- スコア（右上） -->
                            <Border Background="#CC000000" CornerRadius="8"
                                    HorizontalAlignment="Right" VerticalAlignment="Top" Margin="6">
                                <TextBlock Foreground="White" FontWeight="Bold" Padding="6,2"
                                           Text="{Binding ScoreDisplay}"/>
                            </Border>

                            <!-- サブ要約（下） -->
                            <Border Background="#99000000" CornerRadius="8"
                                    HorizontalAlignment="Stretch" VerticalAlignment="Bottom" Margin="6">
                                <StackPanel Orientation="Horizontal" Margin="8,4">
                                    <TextBlock Foreground="Gainsboro" Margin="0,0,12,0"
                                               Text="{Binding SubSummaryCRCD}"/>
                                    <TextBlock Foreground="Gainsboro" Margin="0,0,12,0"
                                               Text="{Binding SubSummaryOthers}"/>
                                </StackPanel>
                            </Border>
                        </Grid>
                        <Border.ToolTip>
                            <StackPanel>
                                <TextBlock Text="{Binding SetSlotText}" FontWeight="Bold"/>
                                <TextBlock Text="{Binding MainText}" />
                                <TextBlock Text="{Binding SubDetailText}" />
                            </StackPanel>
                        </Border.ToolTip>
                    </Border>
                </DataTemplate>
            </Grid.Resources>

            <!-- 画像モード -->
            <ScrollViewer Visibility="{Binding IsImageMode, Converter={StaticResource BoolToVisibility}}">
                <ItemsControl ItemsSource="{Binding Artifacts}" ItemTemplate="{StaticResource ArtifactCardTemplate}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel IsItemsHost="True"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </ScrollViewer>

            <!-- 文字モード -->
            <DataGrid ItemsSource="{Binding Artifacts}"
                      Visibility="{Binding IsImageMode, Converter={StaticResource InverseBoolToVisibility}}"
                      AutoGenerateColumns="False" CanUserSortColumns="True"
                      EnableRowVirtualization="True" EnableColumnVirtualization="True"
                      HeadersVisibility="Column" GridLinesVisibility="None">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Score" Binding="{Binding Score, StringFormat={}{0:F1}}" SortMemberPath="Score"/>
                    <DataGridTextColumn Header="Set"   Binding="{Binding SetName}"/>
                    <DataGridTextColumn Header="Slot"  Binding="{Binding SlotName}"/>
                    <DataGridTextColumn Header="Rarity" Binding="{Binding Rarity}"/>
                    <DataGridTextColumn Header="Lv" Binding="{Binding Level}"/>
                    <DataGridTextColumn Header="Main" Binding="{Binding MainText}"/>
                    <DataGridTextColumn Header="CR(サブ)" Binding="{Binding CR, StringFormat={}{0:F1}}" SortMemberPath="CR"/>
                    <DataGridTextColumn Header="CD(サブ)" Binding="{Binding CD, StringFormat={}{0:F1}}" SortMemberPath="CD"/>
                    <DataGridTextColumn Header="ATK%(サブ)" Binding="{Binding ATKp, StringFormat={}{0:F1}}" SortMemberPath="ATKp"/>
                    <DataGridTextColumn Header="HP%(サブ)" Binding="{Binding HPp, StringFormat={}{0:F1}}" SortMemberPath="HPp"/>
                    <DataGridTextColumn Header="DEF%(サブ)" Binding="{Binding DEFp, StringFormat={}{0:F1}}" SortMemberPath="DEFp"/>
                    <DataGridTextColumn Header="EM(サブ)" Binding="{Binding EM, StringFormat={}{0:F1}}" SortMemberPath="EM"/>
                    <DataGridTextColumn Header="Lock" Binding="{Binding IsLocked}"/>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>

        <!-- ステータスバー -->
        <StatusBar DockPanel.Dock="Bottom">
            <StatusBarItem Content="{Binding SummaryText}"/>
        </StatusBar>
    </DockPanel>
</Window>
